FROM monkey/humble:no-gpu

# Install packages 
RUN apt-get update \
    && apt-get install -y \
    python3-pip \
    cmake \
    libzmq3-dev \
    libboost-dev \
    # ros-humble-behaviortree-cpp \
    && pip install python-can[serial] \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user
# ARG USERNAME=monkey
# USER $USERNAME

ARG HOME_DIR=/root

# Clone BTCPP and BTROS2 and build dep_ws
WORKDIR ${HOME_DIR}/dep_ws/src
RUN git clone https://github.com/BehaviorTree/BehaviorTree.CPP.git

# Renaming BehaviorTree.CPP --> behaviortree_cpp (so BTROS2 can find the package)
RUN mv BehaviorTree.CPP behaviortree_cpp

# Building BTCPP using cmake and make
WORKDIR ${HOME_DIR}/dep_ws/src/behaviortree_cpp
RUN mkdir build

WORKDIR ${HOME_DIR}/dep_ws/src/behaviortree_cpp/build
RUN cmake .. \
    && make \
    && sudo make install

# Copy and build arm_ws
RUN mkdir /root/arm_ws/
COPY monkey_arm /root/arm_ws/src

WORKDIR ${HOME_DIR}/arm_ws/src
# RUN git clone https://github.com/BehaviorTree/BehaviorTree.ROS2.git -b humble
# # Reverting back the BTROS2 that does not use generate_parameters_library
# WORKDIR ${HOME_DIR}/arm_ws/src/BehaviorTree.ROS2
# RUN git reset --hard 784d4e9
# RUN mv behaviortree_ros2 /root/arm_ws/src
# RUN mv btcpp_ros2_interfaces /root/arm_ws/src

# WORKDIR ${HOME_DIR}/arm_ws/src

RUN . /opt/ros/${ROS_DISTRO}/setup.sh \
    && colcon build
# RUN colcon build --packages-select btcpp_ros2_interfaces
# RUN colcon build --packages-select behaviortree_ros2

# WORKDIR ${HOME_DIR}/arm_ws/src

# WORKDIR /root/arm_ws/src

# RUN colcon build
# RUN rm -r BehaviorTree.ROS2
# RUN colcon build

# Source and build BTROS2
# RUN . /opt/ros/${ROS_DISTRO}/setup.sh \
#     && colcon build --packages-select btcpp_ros2_interfaces \
#     && colcon build --packages-select behaviortree_ros2


# RUN echo "source /root/dep_ws/install/setup.bash" >> /root/.bashrc
# WORKDIR ${HOME_DIR}/dep_ws/src
# RUN . /opt/ros/${ROS_DISTRO}/setup.sh \
#     && cd ${HOME_DIR}/dep_ws/ \
#     && colcon build

    # && . ${HOME_DIR}/dep_ws/install/setup.sh \
    # && cd /root/arm_ws/src
   
# USER root

# Set up .bashrc scripts
RUN echo "source /root/arm_ws/install/setup.bash" >> /root/.bashrc

WORKDIR /root

CMD ["bash"]